{% extends "base.html" %}
{% block title %}الحجز — وجهة السعودية{% endblock %}
{% block content %}
<section class="container" style="padding:20px 0">
  <h1 class="page-title">الحجز</h1>

  {% if not trips or trips|length == 0 %}
    <p class="muted">لا توجد رحلات متاحة حاليًا.</p>
    <p><a class="btn btn--ghost" href="{{ url_for('trips') }}">العودة إلى الرحلات</a></p>
  {% else %}
  <div class="cards" style="margin-top:10px">
    <article class="card" style="grid-column: span 12; padding:16px;">
      <form id="bookingForm" action="{{ url_for('booking') }}" method="post" novalidate>
        <div class="field">
          <label for="trip">اختر الرحلة</label>
          <select id="trip" name="trip" required>
            {% for t in trips %}
              <option value="{{ t.slug }}"
                      data-price="{{ t.price_per_day }}"
                      {% if selected_slug and selected_slug == t.slug %}selected{% elif not selected_slug and loop.first %}selected{% endif %}>
                {{ t.title }} — {{ t.city }}
              </option>
            {% endfor %}
          </select>
          <small class="muted">سيتم حساب السعر التقديري حسب الأيام وعدد الأشخاص والسعر اليومي.</small>
        </div>

        <div class="field">
          <label for="days">عدد الأيام</label>
          <input id="days" name="days" type="number" inputmode="numeric" value="1" min="1" max="7" required>
          <small class="muted">الحد الأدنى 1 والحد الأقصى 7 أيام.</small>
        </div>

        <div class="field">
          <label for="persons">عدد الأشخاص</label>
          <input id="persons" name="persons" type="number" inputmode="numeric" value="1" min="1" max="20" required>
          <small class="muted">يمكن تعديل العدد بحسب المجموعة.</small>
        </div>

        <div class="field">
          <label for="date">تاريخ البدء (اختياري)</label>
          <input id="date" name="date" type="date">
        </div>

        <div class="field">
          <label for="name">الاسم الكامل</label>
          <input id="name" name="name" type="text" placeholder="اكتب اسمك" required>
        </div>

        <div class="field">
          <label for="email">البريد الإلكتروني</label>
          <input id="email" name="email" type="email" placeholder="example@email.com" required>
        </div>

        <div class="field">
          <label for="phone">رقم الجوال</label>
          <input id="phone" name="phone" type="tel" placeholder="05xxxxxxxx" required>
        </div>

        <div class="field" style="display:flex;gap:8px;align-items:flex-start;">
          <input id="agree" name="agree" type="checkbox" style="margin-top:4px;">
          <label for="agree" style="margin:0;">
            أوافق على <a href="{{ url_for('cancellation') }}">سياسة الإلغاء</a> وشروط الحجز.
          </label>
        </div>

        <div class="card__actions" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
          <button class="btn btn--primary" type="submit">تأكيد البيانات</button>
          <a class="btn btn--ghost" href="{{ url_for('trips') }}">عودة للرحلات</a>
        </div>
      </form>
    </article>

    <article class="card" style="grid-column: span 12; padding:16px;">
      <h3 style="margin:0 0 8px;">الملخص التقديري</h3>
      <p class="muted" style="margin:0 0 6px;">السعر اليومي: <strong id="ppd">—</strong> ر.س</p>
      <p class="muted" style="margin:0 0 6px;">الأيام: <strong id="daysOut">—</strong> — الأشخاص: <strong id="personsOut">—</strong></p>
      <p class="muted" style="margin:0 0 12px;">الإجمالي (تقديري): <strong id="total">—</strong> ر.س</p>
      <div class="note">
        <strong>معلومة:</strong> هذه الأرقام تقديرية. بعد التأكيد ستصل إلى صفحة نجاح تتضمن زر “إتمام الدفع”.
      </div>
    </article>
  </div>
  {% endif %}
</section>

<script>
(function(){
  const sel = document.getElementById('trip');
  const days = document.getElementById('days');
  const persons = document.getElementById('persons');
  const ppdEl = document.getElementById('ppd');
  const totalEl = document.getElementById('total');
  const daysOut = document.getElementById('daysOut');
  const personsOut = document.getElementById('personsOut');

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function toInt(v, d){ const n = parseInt(v, 10); return isFinite(n) ? n : d; }

  function updatePrice(){
    if(!sel || !days || !persons) return;

    const price = toInt(sel.options[sel.selectedIndex]?.dataset?.price, 0);
    const d = clamp(toInt(days.value, 1), toInt(days.min, 1), toInt(days.max, 7));
    const p = clamp(toInt(persons.value, 1), toInt(persons.min, 1), toInt(persons.max, 20));

    days.value = d;
    persons.value = p;

    const total = price * d * p;

    ppdEl.textContent = price > 0 ? price.toLocaleString('ar-SA') : '—';
    daysOut.textContent = d;
    personsOut.textContent = p;
    totalEl.textContent = total > 0 ? total.toLocaleString('ar-SA') : '—';
  }

  if(sel) sel.addEventListener('change', updatePrice);
  if(days) days.addEventListener('input', updatePrice);
  if(persons) persons.addEventListener('input', updatePrice);

  updatePrice();
})();
</script>
{% endblock %}