{% extends "base.html" %}
{% block title %}الحجز{% endblock %}

{% block content %}
<section class="section">
  <div class="container">
    <h1 class="page-title">نموذج الحجز</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="stack">
          {% for cat, msg in messages %}
            <div class="alert alert--{{ cat }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if submitted and submit_payload %}
      <div class="card success-card">
        <h2>شكرًا لك!</h2>
        <p>تم استلام طلب الحجز. سنرسل لك رسالة تأكيد على البريد الإلكتروني.</p>
        <div class="divider"></div>
        <ul class="summary">
          <li><strong>الاسم:</strong> {{ submit_payload.name }}</li>
          <li><strong>الرحلة:</strong> {{ submit_payload.trip.name }}</li>
          <li><strong>عدد الأيام:</strong> {{ submit_payload.days }}</li>
          <li><strong>الإجمالي:</strong> {{ submit_payload.total }} {{ currency }}</li>
        </ul>
        <div class="actions">
          <button class="btn btn--ghost" onclick="window.print()">طباعة / حفظ PDF</button>
          <a class="btn btn--primary" href="{{ url_for('home') }}">العودة للرئيسية</a>
        </div>
      </div>
    {% endif %}

    <form id="bookingForm" class="form card" method="post" action="{{ url_for('book') }}">
      <div class="form__row">
        <label class="form__label">الاسم الكامل</label>
        <input class="input" type="text" name="name" placeholder="الاسم" required>
      </div>

      <div class="form__row">
        <label class="form__label">البريد الإلكتروني</label>
        <input class="input" type="email" name="email" placeholder="name@email.com" required>
      </div>

      <div class="form__row">
        <label class="form__label">رقم الجوال</label>
        <input class="input" type="tel" name="phone" inputmode="numeric" pattern="05[0-9]{8}" placeholder="05xxxxxxxx" required>
      </div>

      <div class="form__row">
        <label class="form__label">اختر الرحلة</label>
        <select id="tripSelect" class="select" name="trip_id" required>
          <option value="" disabled {% if not selected_trip_id %}selected{% endif %}>اختر الرحلة</option>
          {% for t in trips %}
          <option
            value="{{ t.id }}"
            data-price="{{ t.price }}"
            data-name="{{ t.name }}"
            {% if selected_trip_id == t.id %}selected{% endif %}>
            {{ t.name }} — {{ t.price }} {{ currency }} / اليوم
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form__row">
        <label class="form__label">تاريخ البداية</label>
        <input id="startDate" class="input" type="date" name="start_date" min="{{ today }}" required>
      </div>

      <div class="form__row">
        <label class="form__label">عدد الأيام</label>
        <div class="stepper">
          <button class="stepper__btn" type="button" data-step="-1" aria-label="نقص">−</button>
          <input id="daysInput" class="input input--center" type="number" name="days" value="1" min="1" max="7" required>
          <button class="stepper__btn" type="button" data-step="1" aria-label="زيادة">+</button>
        </div>
        <div class="hint">الحد الأدنى 1 والحد الأقصى 7 أيام</div>
      </div>

      <div class="form__row">
        <label class="form__label">السعر لليوم</label>
        <input id="pricePerDay" class="input" type="text" value="0 {{ currency }}" readonly>
      </div>

      <div class="total box">
        <div>الإجمالي المتوقع</div>
        <div id="totalAmount">0 {{ currency }}</div>
        <small>سيتم تأكيد السعر النهائي قبل الدفع.</small>
      </div>

      <div class="form__row form__row--check">
        <label class="checkbox">
          <input id="agree" type="checkbox" required>
          <span>أوافق على <a href="{{ url_for('cancellation') }}" target="_blank">سياسة الإلغاء</a></span>
        </label>
      </div>

      <div class="form__actions">
        <button id="submitBtn" class="btn btn--primary" type="submit" disabled>إرسال الحجز</button>
      </div>
    </form>
  </div>
</section>
{% endblock %}